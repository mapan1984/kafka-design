
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="kafka 设计实现解析">
      
      
        <meta name="author" content="mapan">
      
      
        <link rel="canonical" href="https://mapan1984.github.io/kafka-design/1-server%20%E8%A7%A3%E6%9E%90/3-KafkaController/3-reassign-partitions/">
      
      
        <link rel="prev" href="../2-controller%E7%BB%84%E4%BB%B6/4-ControllerChannelManager/">
      
      
        <link rel="next" href="../4-delete-topic/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.4">
    
    
      
        <title>1.3.3 reassign partitions - kafka 设计实现解析</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#133-controller" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="kafka 设计实现解析" class="md-header__button md-logo" aria-label="kafka 设计实现解析" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            kafka 设计实现解析
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              1.3.3 reassign partitions
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mapan1984/kafka-design/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="kafka 设计实现解析" class="md-nav__button md-logo" aria-label="kafka 设计实现解析" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    kafka 设计实现解析
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mapan1984/kafka-design/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0. kafka 设计实现解析
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1. server 解析
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            1. server 解析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1-server%20%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.1 server 启动过程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2-server%20%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.2 server 网络模型
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.3 KafkaController
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            1.3 KafkaController
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1-controller%E5%90%AF%E5%8A%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3.1 KafkaController 启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../2-controller%E7%BB%84%E4%BB%B6/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.3.2 KafkaController 组件
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3_2" id="__nav_2_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            1.3.2 KafkaController 组件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-controller%E7%BB%84%E4%BB%B6/1-ControllerContext/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3.2.1 ControllerContext
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-controller%E7%BB%84%E4%BB%B6/2-ReplicaStateMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3.2.2 ReplicaStateMachine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-controller%E7%BB%84%E4%BB%B6/3-PartitionStateMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3.2.3 PartitionStateMachine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2-controller%E7%BB%84%E4%BB%B6/4-ControllerChannelManager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3.2.4 ControllerChannelManager
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    1.3.3 reassign partitions
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4-delete-topic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.3.4 delete topic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../4-ReplicaManager/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.4 ReplicaManager
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            1.4 ReplicaManager
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4-ReplicaManager/1-replica%20manager%20%E5%90%AF%E5%8A%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4.1 ReplicaManager 启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4-ReplicaManager/2-isr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4.2 isr
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4-ReplicaManager/3-become-leader-or-follower/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4.3 become leader or follower
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4-ReplicaManager/4-replica-fetcher-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4.4 replica fetcher manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4-ReplicaManager/7-append-records/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4.7 append records
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4-ReplicaManager/8-delete-records/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4.8 delete records
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4-ReplicaManager/9-replication-quota-manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.4.8 replication quota manager
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../5-GroupCoordinator/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.5 GroupCoordinator
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            1.5 GroupCoordinator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../5-GroupCoordinator/1-coordinator%E5%90%AF%E5%8A%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.5.1 coordinator 启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../5-GroupCoordinator/2-coordinator%E5%88%87%E6%8D%A2%E5%8F%8A%E6%9B%B4%E6%96%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.5.2 coordinator 切换及更新
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../6-LogManager/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.6 LogManager
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            1.6 LogManager
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6-LogManager/1-LogManager%20%E5%90%AF%E5%8A%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6.1 LogManager 启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6-LogManager/2-%E6%97%A5%E5%BF%97%E6%B8%85%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6.2 日志清理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6-LogManager/3-flush%20log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6.3 flush log
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6-LogManager/4-recovery-point/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6.4 recovery point
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6-LogManager/5-start-offset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6.5 start offset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6-LogManager/7-%E5%8E%8B%E7%BC%A9%E7%AD%96%E7%95%A5%E7%9A%84%E6%97%A5%E5%BF%97%E6%B8%85%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6.7 压缩策略的日志清理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../6-LogManager/8-LogSegment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.6.8 LogSegment
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../7-acl%20%E6%8E%A7%E5%88%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.7 Acl 权限控制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../9-Metrics/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.9 Metrics
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            1.9 Metrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../9-Metrics/1-Yammer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.9.1 Yammer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../9-Metrics/2-KafkaMetricsGroup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.9.2 Kafka Metrics Group
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../10-Config/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.10 Config
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            1.10 Config
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../10-Config/1-KafkaConfig/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.10.1 Kafka Config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../10-Config/2-Dynamic-Config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.10.2 Dynamic Config
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../2-producer%20%E8%A7%A3%E6%9E%90/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    2. producer 解析
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            2. producer 解析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../2-producer%20%E8%A7%A3%E6%9E%90/1-producer%20%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.1 producer 发送消息
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../2-producer%20%E8%A7%A3%E6%9E%90/2-producer%20%E5%B9%82%E7%AD%89%E6%80%A7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.2 producer 幂等性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../2-producer%20%E8%A7%A3%E6%9E%90/3-producer%20%E5%8A%A0%E5%AF%86%20%E8%AE%A4%E8%AF%81/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.3 producer 加密/认证
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../3-consumer%20%E8%A7%A3%E6%9E%90/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    3. consumer 解析
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            3. consumer 解析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../3-consumer%20%E8%A7%A3%E6%9E%90/1-%E6%B6%88%E8%B4%B9%E7%BB%84%E7%AE%A1%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.1-消费组管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../3-consumer%20%E8%A7%A3%E6%9E%90/2-consumer%20%E6%8B%89%E5%8F%96%E6%B6%88%E6%81%AF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.2-拉取消息
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../4-kafka-network-io/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    4. kafka network io
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            4. kafka network io
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../4-kafka-network-io/1-KafkaChannel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.1 KafkaChannel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../4-kafka-network-io/2-TransportLayer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.2 TransportLayer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../4-kafka-network-io/3-Authenticator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.3 Authenticator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../5-release%20note/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    5. Release Note
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            5. Release Note
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5-release%20note/2.7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.7
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../5-release%20note/2.8.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.8.0
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../6-src/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    6. Src
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            6. Src
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Clients
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            Clients
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1_1" id="__nav_7_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Clients
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_1">
            <span class="md-nav__icon md-icon"></span>
            Clients
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_1_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1_1_1" id="__nav_7_1_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Producer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            Producer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_1_1_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1_1_1_1" id="__nav_7_1_1_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Internals
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_7_1_1_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            Internals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/clients/producer/internals/ProducerBatch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Producer Batch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/clients/producer/internals/ProducerMetadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Producer Metadata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/clients/producer/internals/RecordAccumulator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Record Accumulator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/clients/producer/internals/Sender/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sender
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/clients/producer/KafkaProducer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Producer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/clients/Metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metadata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/clients/NetworkClient/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Client
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_2" >
        
          
          <label class="md-nav__link" for="__nav_7_1_2" id="__nav_7_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Common
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_2">
            <span class="md-nav__icon md-icon"></span>
            Common
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_2_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1_2_1" id="__nav_7_1_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Network
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_2_1">
            <span class="md-nav__icon md-icon"></span>
            Network
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/network/KafkaChannel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Channel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/network/NetworkReceive/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Receive
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/network/NetworkSend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Send
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/network/Receive/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receive
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/network/Selector/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Selector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/network/Send/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Send
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/network/TransportLayer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transport Layer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_2_2" >
        
          
          <label class="md-nav__link" for="__nav_7_1_2_2" id="__nav_7_1_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_2_2">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/clients/common/utils/KafkaThread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Thread
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../6-src/core/kafka/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Kafka
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2_1" id="__nav_7_2_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1">
            <span class="md-nav__icon md-icon"></span>
            Kafka
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_7_2_1_1" id="__nav_7_2_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Controller
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            Controller
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/controller/ControllerState/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControllerState
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/controller/ReplicaStateMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ReplicaStateMachine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_1_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../6-src/core/kafka/controller/ControllerContext/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ControllerContext
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2_1_1_3" id="__nav_7_2_1_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_7_2_1_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_1_3">
            <span class="md-nav__icon md-icon"></span>
            ControllerContext
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/controller/ControllerContext/ReplicaAssignment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ReplicaAssignment
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_1_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../6-src/core/kafka/controller/ControllerEventManager/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    ControllerEventManager
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2_1_1_4" id="__nav_7_2_1_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_7_2_1_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_1_4">
            <span class="md-nav__icon md-icon"></span>
            ControllerEventManager
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/controller/ControllerEventManager/ControllerEventProcessor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControllerEventProcessor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/controller/ControllerEventManager/ControllerEventThread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControllerEventThread
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/controller/ControllerEventManager/QueueEvent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QueueEvent
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_1_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../6-src/core/kafka/controller/KafkaController/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    KafkaController
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2_1_1_5" id="__nav_7_2_1_1_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_7_2_1_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_1_5">
            <span class="md-nav__icon md-icon"></span>
            KafkaController
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/controller/KafkaController/ControllerEvent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControllerEvent
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2_1_2" id="__nav_7_2_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Network
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            Network
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_2_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../6-src/core/kafka/network/SocketServer/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Socket Server
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2_1_2_1" id="__nav_7_2_1_2_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_7_2_1_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_2_1">
            <span class="md-nav__icon md-icon"></span>
            Socket Server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/network/SocketServer/Acceptor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Acceptor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/network/SocketServer/Processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Processor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/network/RequestChannel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Request Channel
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_3" >
        
          
          <label class="md-nav__link" for="__nav_7_2_1_3" id="__nav_7_2_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Server
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            Server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_3_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../6-src/core/kafka/server/KafkaRequestHandler/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Kafka Request Handler
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_2_1_3_1" id="__nav_7_2_1_3_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_7_2_1_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_3_1">
            <span class="md-nav__icon md-icon"></span>
            Kafka Request Handler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/server/KafkaRequestHandler/KafkaRequestHandlerPool/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Request Handler Pool
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/server/KafkaApis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Apis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/server/KafkaServer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Server
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1_4" >
        
          
          <label class="md-nav__link" for="__nav_7_2_1_4" id="__nav_7_2_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_2_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../6-src/core/kafka/utils/KafkaScheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Scheduler
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    7. 其他
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            7. 其他
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../7-other/1-topic-name-limit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.1 topic 名规则
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../7-other/2-kafka-page-cache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.2 page cache
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../7-other/3-reassign-partition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.3 reassign partition
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="133-controller">1.3.3 controller</h1>
<p>在 controller 启动过程中，在 <code>KafkaController.onControllerFailover()</code> 方法中向 zkClient 注册了 <code>PartitionReassignmentHandler</code></p>
<p><code>PartitionReassignmentHandler</code> 如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PartitionReassignmentHandler</span><span class="p">(</span><span class="n">eventManager</span><span class="p">:</span><span class="w"> </span><span class="nc">ControllerEventManager</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">ZNodeChangeHandler</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ReassignPartitionsZNode</span><span class="p">.</span><span class="n">path</span>

<span class="w">  </span><span class="c1">// Note that the event is also enqueued when the znode is deleted, but we do it explicitly instead of relying on</span>
<span class="w">  </span><span class="c1">// handleDeletion(). This approach is more robust as it doesn&#39;t depend on the watcher being re-registered after</span>
<span class="w">  </span><span class="c1">// it&#39;s consumed during data changes (we ensure re-registration when the znode is deleted).</span>
<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">handleCreation</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventManager</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="nc">ZkPartitionReassignment</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>这里实际上是监听 zookeeper <code>/admin/reassign_partitions</code> 节点，如果有新节点创建，则向 eventManager 事件队列 queue 增加 <code>ZkPartitionReassignment</code></p>
<p>eventManager 会启动单独的线程不断从事件队列中取出事件，通过 processor 进行处理</p>
<p>eventManager 的 processor 是 KafkaController 的实例，因此可以在 <code>KafkaController.process()</code> 方法里找到对 <code>ZkPartitionReassignment</code> 的处理</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">event</span><span class="p">:</span><span class="w"> </span><span class="nc">ControllerEvent</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">event</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="n">event</span><span class="p">:</span><span class="w"> </span><span class="nc">MockEvent</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">          </span><span class="c1">// Used only in test cases</span>
<span class="w">          </span><span class="n">event</span><span class="p">.</span><span class="n">process</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// ...</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nc">ApiPartitionReassignment</span><span class="p">(</span><span class="n">reassignments</span><span class="p">,</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">          </span><span class="n">processApiPartitionReassignment</span><span class="p">(</span><span class="n">reassignments</span><span class="p">,</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nc">ZkPartitionReassignment</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">          </span><span class="n">processZkPartitionReassignment</span><span class="p">()</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nc">ListPartitionReassignments</span><span class="p">(</span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">          </span><span class="n">processListPartitionReassignments</span><span class="p">(</span><span class="n">partitions</span><span class="p">,</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nc">PartitionReassignmentIsrChange</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">          </span><span class="n">processPartitionReassignmentIsrChange</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// ...</span>

<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">ControllerMovedException</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="n">info</span><span class="p">(</span><span class="s">s&quot;Controller moved to another broker when processing </span><span class="si">$</span><span class="n">event</span><span class="s">.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="n">maybeResign</span><span class="p">()</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">Throwable</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="n">error</span><span class="p">(</span><span class="s">s&quot;Error processing event </span><span class="si">$</span><span class="n">event</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">updateMetrics</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>对 <code>ZkPartitionReassignment</code> 通过 <code>processZkPartitionReassignment()</code> 进行处理：</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">processZkPartitionReassignment</span><span class="p">():</span><span class="w"> </span><span class="nc">Set</span><span class="p">[</span><span class="nc">TopicPartition</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// We need to register the watcher if the path doesn&#39;t exist in order to detect future</span>
<span class="w">    </span><span class="c1">// reassignments and we get the `path exists` check for free</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isActive</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">zkClient</span><span class="p">.</span><span class="n">registerZNodeChangeHandlerAndCheckExistence</span><span class="p">(</span><span class="n">partitionReassignmentHandler</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">reassignmentResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutable</span><span class="p">.</span><span class="nc">Map</span><span class="p">.</span><span class="n">empty</span><span class="p">[</span><span class="nc">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="nc">ApiError</span><span class="p">]</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">partitionsToReassign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mutable</span><span class="p">.</span><span class="nc">Map</span><span class="p">.</span><span class="n">empty</span><span class="p">[</span><span class="nc">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="nc">ReplicaAssignment</span><span class="p">]</span>

<span class="w">      </span><span class="c1">// 这里组合了现在的 replica 和 targetReplica</span>
<span class="w">      </span><span class="n">zkClient</span><span class="p">.</span><span class="n">getPartitionReassignment</span><span class="p">.</span><span class="n">forKeyValue</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">targetReplicas</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">        </span><span class="n">maybeBuildReassignment</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">targetReplicas</span><span class="p">))</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">partitionsToReassign</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="nc">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">reassignmentResults</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ApiError</span><span class="p">(</span><span class="nc">Errors</span><span class="p">.</span><span class="nc">NO_REASSIGNMENT_IN_PROGRESS</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// 触发 partition reassignment</span>
<span class="w">      </span><span class="n">reassignmentResults</span><span class="w"> </span><span class="o">++=</span><span class="w"> </span><span class="n">maybeTriggerPartitionReassignment</span><span class="p">(</span><span class="n">partitionsToReassign</span><span class="p">)</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="p">(</span><span class="n">partitionsReassigned</span><span class="p">,</span><span class="w"> </span><span class="n">partitionsFailed</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reassignmentResults</span><span class="p">.</span><span class="n">partition</span><span class="p">(</span><span class="n">_</span><span class="p">.</span><span class="n">_2</span><span class="p">.</span><span class="n">error</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nc">Errors</span><span class="p">.</span><span class="nc">NONE</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">partitionsFailed</span><span class="p">.</span><span class="n">nonEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">warn</span><span class="p">(</span><span class="s">s&quot;Failed reassignment through zk with the following errors: </span><span class="si">$</span><span class="n">partitionsFailed</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">maybeRemoveFromZkReassignment</span><span class="p">((</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">partitionsFailed</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">partitionsReassigned</span><span class="p">.</span><span class="n">keySet</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nc">Set</span><span class="p">.</span><span class="n">empty</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Trigger a partition reassignment provided that the topic exists and is not being deleted.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called when a reassignment is initially received either through Zookeeper or through the</span>
<span class="cm"> * AlterPartitionReassignments API</span>
<span class="cm"> *</span>
<span class="cm"> * The `partitionsBeingReassigned` field in the controller context will be updated by this</span>
<span class="cm"> * call after the reassignment completes validation and is successfully stored in the topic</span>
<span class="cm"> * assignment zNode.</span>
<span class="cm"> *</span>
<span class="cm"> * @param reassignments The reassignments to begin processing</span>
<span class="cm"> * @return A map of any errors in the reassignment. If the error is NONE for a given partition,</span>
<span class="cm"> *         then the reassignment was submitted successfully.</span>
<span class="cm"> */</span>
<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">maybeTriggerPartitionReassignment</span><span class="p">(</span><span class="n">reassignments</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="nc">ReplicaAssignment</span><span class="p">]):</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="nc">ApiError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">reassignments</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">reassignment</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tp</span><span class="p">.</span><span class="n">topic</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">apiError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">topicDeletionManager</span><span class="p">.</span><span class="n">isTopicQueuedUpForDeletion</span><span class="p">(</span><span class="n">topic</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">info</span><span class="p">(</span><span class="s">s&quot;Skipping reassignment of </span><span class="si">$</span><span class="n">tp</span><span class="s"> since the topic is currently being deleted&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="nc">ApiError</span><span class="p">(</span><span class="nc">Errors</span><span class="p">.</span><span class="nc">UNKNOWN_TOPIC_OR_PARTITION</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The partition does not exist.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">assignedReplicas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controllerContext</span><span class="p">.</span><span class="n">partitionReplicaAssignment</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">assignedReplicas</span><span class="p">.</span><span class="n">nonEmpty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">onPartitionReassignment</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="w"> </span><span class="n">reassignment</span><span class="p">)</span>
<span class="w">          </span><span class="nc">ApiError</span><span class="p">.</span><span class="nc">NONE</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">ControllerMovedException</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">            </span><span class="n">info</span><span class="p">(</span><span class="s">s&quot;Failed completing reassignment of partition </span><span class="si">$</span><span class="n">tp</span><span class="s"> because controller has moved to another broker&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">Throwable</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">            </span><span class="n">error</span><span class="p">(</span><span class="s">s&quot;Error completing reassignment of partition </span><span class="si">$</span><span class="n">tp</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="nc">ApiError</span><span class="p">(</span><span class="nc">Errors</span><span class="p">.</span><span class="nc">UNKNOWN_SERVER_ERROR</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="nc">ApiError</span><span class="p">(</span><span class="nc">Errors</span><span class="p">.</span><span class="nc">UNKNOWN_TOPIC_OR_PARTITION</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The partition does not exist.&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">tp</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">apiError</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>定义以下概念：
- RS: 当前副本集合
- ORS: 原始副本集合
- TRS: 目标副本集合
- AR: 在这次重分配中要增加的副本
- RR: 在这次重分配中要移除的副本</p>
<p>假设一个 topic 当前副本集为 1,2,3 ，则其 RS 和 ORS 为 1,2,3</p>
<p>如果要将其重分配为 4,5,6 ，则其 TRS 为 4,5,6 , AR 为 4,5,6 , RR 为 1,2,3</p>
<table>
<thead>
<tr>
<th>RS</th>
<th>AR</th>
<th>RR</th>
<th>leader</th>
<th>isr</th>
<th>step</th>
</tr>
</thead>
<tbody>
<tr>
<td>1,2,3</td>
<td></td>
<td></td>
<td>1</td>
<td>1,2,3</td>
<td>initial state</td>
</tr>
<tr>
<td>4,5,6,1,2,3</td>
<td>4,5,6</td>
<td>1,2,3</td>
<td>1</td>
<td>1,2,3</td>
<td>step A2</td>
</tr>
<tr>
<td>4,5,6,1,2,3</td>
<td>4,5,6</td>
<td>1,2,3</td>
<td>1</td>
<td>1,2,3,4,5,6</td>
<td>phase B</td>
</tr>
<tr>
<td>4,5,6,1,2,3</td>
<td>4,5,6</td>
<td>1,2,3</td>
<td>4</td>
<td>1,2,3,4,5,6</td>
<td>step B3</td>
</tr>
<tr>
<td>4,5,6,1,2,3</td>
<td>4,5,6</td>
<td>1,2,3</td>
<td>4</td>
<td>4,5,6</td>
<td>step B4</td>
</tr>
<tr>
<td>4,5,6</td>
<td></td>
<td></td>
<td>4</td>
<td>4,5,6</td>
<td>step B6</td>
</tr>
</tbody>
</table>
<p>将整个重分配过程分为 3 个阶段，每个阶段有自己的步骤
1. Phase U (Assignment update)
    1. U1: 更新 Zk 使 RS = ORS + TRS, AR = TRS - ORS, RR = ORS - TRS
    2. U2: 更新 memory 使 RS = ORS + TRS, AR = TRS - ORS, RR = ORS - TRS
    3. U3: 如果正在取消当前的重分配或者替换当前的重分配，向所有不在新分配的 TRS 的 AR 发送 <code>StopReplica</code> 请求
2. Phase A (when TRS != ISR)
    1. A1: bump the leader epoch for the partition and send LeaderAndIsr updates to RS
    2. A2: 通过将 AR 中的 replicas 置为 <code>NewReplica</code> 状态启动新的 replicas
3. Phase B (when TRS == ISR)
    1. B1: 将所有 AR 中的 replicas 置为 <code>OnlineReplica</code> 状态
    2. B2: 更新 memory 使 RS = TRS, AR = [], RR = []
    3. B3: 发送表示 RS = TRS 的 <code>LeaderAndIsr</code> 请求。This will prevent the leader from adding any replica in TRS - ORS back in the isr. 如果当前 leader 不在 TRS 里或者不是存活的，we move the leader to a new replica in TRS. We may send the LeaderAndIsr to more than the TRS replicas due to the way the partition state machine works (it reads replicas from ZK)
    4. B4: 将所有 RR 中的 replicas 置为 <code>OfflineReplica</code> 状态。As part of <code>OfflineReplica</code> state change, we shrink the isr to remove RR in ZooKeeper and send a <code>LeaderAndIsr</code> ONLY to the Leader to notify it of the shrunk isr. After that, we send a <code>StopReplica (delete = false)</code> to the replicas in RR.
    5. B5: 将所有 RR 中的 replicas 置为 <code>NonExistentReplica</code> 状态。This will send a <code>StopReplica (delete = true)</code> to the replicas in RR to physically delete the replicas on disk.
    6. B6: 更新 Zk 使 RS = TRS, AR = [], RR = []
    7. B7: 移除 ISR reassign listener，更新 Zk 的 <code>/admin/reassign_partitions</code> 移除这个 partition
    8. B8: 经过 leader 选举，replicas 和 isr 信息有变更，向所有 broker 发 metadata request</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * This callback is invoked:</span>
<span class="cm"> * 1. By the AlterPartitionReassignments API</span>
<span class="cm"> * 2. By the reassigned partitions listener which is triggered when the /admin/reassign/partitions znode is created</span>
<span class="cm"> * 3. When an ongoing reassignment finishes - this is detected by a change in the partition&#39;s ISR znode</span>
<span class="cm"> * 4. Whenever a new broker comes up which is part of an ongoing reassignment</span>
<span class="cm"> * 5. On controller startup/failover</span>
<span class="cm"> *</span>
<span class="cm"> * Reassigning replicas for a partition goes through a few steps listed in the code.</span>
<span class="cm"> * RS = current assigned replica set</span>
<span class="cm"> * ORS = Original replica set for partition</span>
<span class="cm"> * TRS = Reassigned (target) replica set</span>
<span class="cm"> * AR = The replicas we are adding as part of this reassignment</span>
<span class="cm"> * RR = The replicas we are removing as part of this reassignment</span>
<span class="cm"> *</span>
<span class="cm"> * A reassignment may have up to three phases, each with its own steps:</span>

<span class="cm"> * Phase U (Assignment update): Regardless of the trigger, the first step is in the reassignment process</span>
<span class="cm"> * is to update the existing assignment state. We always update the state in Zookeeper before</span>
<span class="cm"> * we update memory so that it can be resumed upon controller fail-over.</span>
<span class="cm"> *</span>
<span class="cm"> *   U1. Update ZK with RS = ORS + TRS, AR = TRS - ORS, RR = ORS - TRS.</span>
<span class="cm"> *   U2. Update memory with RS = ORS + TRS, AR = TRS - ORS and RR = ORS - TRS</span>
<span class="cm"> *   U3. If we are cancelling or replacing an existing reassignment, send StopReplica to all members</span>
<span class="cm"> *       of AR in the original reassignment if they are not in TRS from the new assignment</span>
<span class="cm"> *</span>
<span class="cm"> * To complete the reassignment, we need to bring the new replicas into sync, so depending on the state</span>
<span class="cm"> * of the ISR, we will execute one of the following steps.</span>
<span class="cm"> *</span>
<span class="cm"> * Phase A (when TRS != ISR): The reassignment is not yet complete</span>
<span class="cm"> *</span>
<span class="cm"> *   A1. Bump the leader epoch for the partition and send LeaderAndIsr updates to RS.</span>
<span class="cm"> *   A2. Start new replicas AR by moving replicas in AR to NewReplica state.</span>
<span class="cm"> *</span>
<span class="cm"> * Phase B (when TRS = ISR): The reassignment is complete</span>
<span class="cm"> *</span>
<span class="cm"> *   B1. Move all replicas in AR to OnlineReplica state.</span>
<span class="cm"> *   B2. Set RS = TRS, AR = [], RR = [] in memory.</span>
<span class="cm"> *   B3. Send a LeaderAndIsr request with RS = TRS. This will prevent the leader from adding any replica in TRS - ORS back in the isr.</span>
<span class="cm"> *       If the current leader is not in TRS or isn&#39;t alive, we move the leader to a new replica in TRS.</span>
<span class="cm"> *       We may send the LeaderAndIsr to more than the TRS replicas due to the</span>
<span class="cm"> *       way the partition state machine works (it reads replicas from ZK)</span>
<span class="cm"> *   B4. Move all replicas in RR to OfflineReplica state. As part of OfflineReplica state change, we shrink the</span>
<span class="cm"> *       isr to remove RR in ZooKeeper and send a LeaderAndIsr ONLY to the Leader to notify it of the shrunk isr.</span>
<span class="cm"> *       After that, we send a StopReplica (delete = false) to the replicas in RR.</span>
<span class="cm"> *   B5. Move all replicas in RR to NonExistentReplica state. This will send a StopReplica (delete = true) to</span>
<span class="cm"> *       the replicas in RR to physically delete the replicas on disk.</span>
<span class="cm"> *   B6. Update ZK with RS=TRS, AR=[], RR=[].</span>
<span class="cm"> *   B7. Remove the ISR reassign listener and maybe update the /admin/reassign_partitions path in ZK to remove this partition from it if present.</span>
<span class="cm"> *   B8. After electing leader, the replicas and isr information changes. So resend the update metadata request to every broker.</span>
<span class="cm"> *</span>
<span class="cm"> * In general, there are two goals we want to aim for:</span>
<span class="cm"> * 1. Every replica present in the replica set of a LeaderAndIsrRequest gets the request sent to it</span>
<span class="cm"> * 2. Replicas that are removed from a partition&#39;s assignment get StopReplica sent to them</span>
<span class="cm"> *</span>
<span class="cm"> * For example, if ORS = {1,2,3} and TRS = {4,5,6}, the values in the topic and leader/isr paths in ZK</span>
<span class="cm"> * may go through the following transitions.</span>
<span class="cm"> * RS                AR          RR          leader     isr</span>
<span class="cm"> * {1,2,3}           {}          {}          1          {1,2,3}           (initial state)</span>
<span class="cm"> * {4,5,6,1,2,3}     {4,5,6}     {1,2,3}     1          {1,2,3}           (step A2)</span>
<span class="cm"> * {4,5,6,1,2,3}     {4,5,6}     {1,2,3}     1          {1,2,3,4,5,6}     (phase B)</span>
<span class="cm"> * {4,5,6,1,2,3}     {4,5,6}     {1,2,3}     4          {1,2,3,4,5,6}     (step B3)</span>
<span class="cm"> * {4,5,6,1,2,3}     {4,5,6}     {1,2,3}     4          {4,5,6}           (step B4)</span>
<span class="cm"> * {4,5,6}           {}          {}          4          {4,5,6}           (step B6)</span>
<span class="cm"> *</span>
<span class="cm"> * Note that we have to update RS in ZK with TRS last since it&#39;s the only place where we store ORS persistently.</span>
<span class="cm"> * This way, if the controller crashes before that step, we can still recover.</span>
<span class="cm"> */</span>
<span class="k">private</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">onPartitionReassignment</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">:</span><span class="w"> </span><span class="nc">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">reassignment</span><span class="p">:</span><span class="w"> </span><span class="nc">ReplicaAssignment</span><span class="p">):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// While a reassignment is in progress, deletion is not allowed</span>
<span class="w">  </span><span class="n">topicDeletionManager</span><span class="p">.</span><span class="n">markTopicIneligibleForDeletion</span><span class="p">(</span><span class="nc">Set</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">.</span><span class="n">topic</span><span class="p">),</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;topic reassignment in progress&quot;</span><span class="p">)</span>

<span class="w">  </span><span class="n">updateCurrentReassignment</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">reassignment</span><span class="p">)</span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">addingReplicas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reassignment</span><span class="p">.</span><span class="n">addingReplicas</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">removingReplicas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reassignment</span><span class="p">.</span><span class="n">removingReplicas</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isReassignmentComplete</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">reassignment</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// A1. Send LeaderAndIsr request to every replica in ORS + TRS (with the new RS, AR and RR).</span>
<span class="w">    </span><span class="n">updateLeaderEpochAndSendRequest</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">reassignment</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// A2. replicas in AR -&gt; NewReplica</span>
<span class="w">    </span><span class="n">startNewReplicasForReassignedPartition</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">addingReplicas</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// B1. replicas in AR -&gt; OnlineReplica</span>
<span class="w">    </span><span class="n">replicaStateMachine</span><span class="p">.</span><span class="n">handleStateChanges</span><span class="p">(</span><span class="n">addingReplicas</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="nc">PartitionAndReplica</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)),</span><span class="w"> </span><span class="nc">OnlineReplica</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// B2. Set RS = TRS, AR = [], RR = [] in memory.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">completedReassignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ReplicaAssignment</span><span class="p">(</span><span class="n">reassignment</span><span class="p">.</span><span class="n">targetReplicas</span><span class="p">)</span>
<span class="w">    </span><span class="n">controllerContext</span><span class="p">.</span><span class="n">updatePartitionFullReplicaAssignment</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">completedReassignment</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// B3. Send LeaderAndIsr request with a potential new leader (if current leader not in TRS) and</span>
<span class="w">    </span><span class="c1">//   a new RS (using TRS) and same isr to every broker in ORS + TRS or TRS</span>
<span class="w">    </span><span class="n">moveReassignedPartitionLeaderIfRequired</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">completedReassignment</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// B4. replicas in RR -&gt; Offline (force those replicas out of isr)</span>
<span class="w">    </span><span class="c1">// B5. replicas in RR -&gt; NonExistentReplica (force those replicas to be deleted)</span>
<span class="w">    </span><span class="n">stopRemovedReplicasOfReassignedPartition</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">removingReplicas</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// B6. Update ZK with RS = TRS, AR = [], RR = [].</span>
<span class="w">    </span><span class="n">updateReplicaAssignmentForPartition</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">completedReassignment</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// B7. Remove the ISR reassign listener and maybe update the /admin/reassign_partitions path in ZK to remove this partition from it.</span>
<span class="w">    </span><span class="n">removePartitionFromReassigningPartitions</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">completedReassignment</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// B8. After electing a leader in B3, the replicas and isr information changes, so resend the update metadata request to every broker</span>
<span class="w">    </span><span class="n">sendUpdateMetadataRequest</span><span class="p">(</span><span class="n">controllerContext</span><span class="p">.</span><span class="n">liveOrShuttingDownBrokerIds</span><span class="p">.</span><span class="n">toSeq</span><span class="p">,</span><span class="w"> </span><span class="nc">Set</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">))</span>
<span class="w">    </span><span class="c1">// signal delete topic thread if reassignment for some partitions belonging to topics being deleted just completed</span>
<span class="w">    </span><span class="n">topicDeletionManager</span><span class="p">.</span><span class="n">resumeDeletionForTopics</span><span class="p">(</span><span class="nc">Set</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">.</span><span class="n">topic</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.c011b7c0.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.7389ff0e.min.js"></script>
      
    
  </body>
</html>